<!DOCTYPE html>
<html>
  <head>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  </head>
  <body>
    <form action="/">
      <button class="btn btn-primary">Home</button>
    </form>
    <br>
    <div class="row">
      <div class="col">
        <p id="list_id">
          <%= list_id %>
        </p>
      </div>
      <div class="col">
        <button class="btn btn-dark" onclick="copyToClipboard()">Copy ID</button>
      </div>
    </div>
    <br>
    <div class="container">
      <ul class="list-group" id="shopping_list_items">
        <% items.forEach(function(item,index){ %>
            <li class="list-group-item" contenteditable="true" onblur="saveChanges(this)"> <%= item %> </li>
        <% }) %>
      </ul>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <script>
      async function copyToClipboard() {
        var copyText = document.getElementById("list_id");
        try {
            await navigator.clipboard.writeText(copyText.innerText);
            alert('Text copied to clipboard');
        } catch (err) {
            alert('Failed to copy text');
        }
      }

      function saveChanges(element) {
        var new_list_html = Array.from(element.parentNode.children);
        var new_list_text = [];
        new_list_html.forEach( (item_html)  => {
          if (item_html.innerText) {
            new_list_text.push(item_html.innerText);
          }
        })
        console.log(`saving new list`);
        console.log(new_list_text)

        list_id = document.getElementById("list_id").innerText;

        fetch('/list/update_list', {
          method: 'POST',
          headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({ "list_id": list_id, "new_list_contents": new_list_text })
        })
      }

      window.onload = function() {
        var list = document.getElementById('shopping_list_items');
        for (var i = 0; i < list.children.length; i++) {
            addEnterListener(list.children[i]);
        }
      }

      function addEnterListener(element) {
        element.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                var nextElement = getNextElement(element);
                if (nextElement) {
                    nextElement.focus();
                } else {
                    addListItem();
                }
            }
        });
      }

      function addListItem() {
          var list = document.getElementById('shopping_list_items');
          var newListElement = document.createElement('li');
          newListElement.contentEditable = 'true';
          newListElement.innerText = '';
          newListElement.classList.add('list-group-item');
          newListElement.onblur = saveChanges(list);
          addEnterListener(newListElement);
          list.appendChild(newListElement);
          newListElement.focus();
      }

      function getNextElement(element) {
          do {
              element = element.nextSibling;
          } while (element && element.nodeType !== 1);
          return element;
      }
    </script>
  </body>
</html>
